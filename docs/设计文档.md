# 图片管理网站 软件设计说明书（详细设计报告）v1.0

> 目标：这份报告可直接用于拆分研发任务、并指导前后端按 **OpenAPI** 对齐开发。
> 架构：**前后端分离**；后端 **Python + Connexion(OpenAPI 驱动)**；前端 **React + @mui/material**；数据库 ORM 同时支持 **SQLite（默认）** 与 **MySQL**；图片原文件落盘；缩略图以 **base64** 存 DB。

---

## 0. 文档信息

- 项目名称：图片管理网站（Image Manager）
- 版本：v1.0
- 状态：可进入开发
- 读者：后端/前端/测试/运维
- 关键约束：

  - 初始化必须创建管理员账号：`admin / 123456`
  - 用户三类：`pending(待审批)`、`user(普通)`、`admin(管理员)`
  - **pending 没有任何权限**
  - 图片原文件保存本地目录：`{root}/{year}/{month}/{day}/{hash}.{ext}`
  - 备份目录：`{root}/backup/{year}/{month}/{day}/{hash}_{timestamp}.{ext}`
  - config 存于项目根目录 `config.yaml`，**不得写入数据库**

### 实现补充（当前交付对照）

- 接口契约：`openapi.yaml` 位于项目根目录，已关闭 swagger-ui（避免缺少依赖阻塞启动），`bearerAuth` 通过 `x-bearerInfoFunc=src.core.security.bearer_info` 校验 JWT。
- 鉴权：Connexion 中间件 + JWT，后台与前端均强制“仅上传者本人可编辑/删除”，管理员也不越权；`pending` 只允许查看个人信息。
- 缩略图：最大边 100px，迭代压缩，确保体积 ≤100KB（配置项 `thumbnail.max_edge/max_bytes/quality` 可调）。
- 配置：`config.yaml` 热加载；可通过管理员接口更新站点名/上传后缀/分页大小/favicon，配置不入库。
- 存储：原图与备份按日期+8位随机 hash 落盘，hash 冲突会重算；缩略图以 base64 入库。
- 前端：React + MUI + React Query；瀑布流响应式（1/2/3 列）；上传提供拖拽/多文件并行与复制直链。
- 预留接口：AI 标注、MCP 检索返回 501 占位，便于后续接入。
---

## 1. 需求范围与目标

### 1.1 范围（本次必须实现）

1. 注册、登录、权限体系（pending/user/admin）
2. 管理员审批用户、提升/降级权限
3. 上传图片（PC/手机浏览器），并发上传、显示进度条
4. 图片落盘存储（按日期目录 + 随机 8 位 hash 文件名）
5. 读取 EXIF：自动生成分类标签及辅助信息（时间、地点、分辨率等）
6. 自定义标签（list）
7. 缩略图生成：**base64 存 DB**
8. 图片信息入库并支持查询/检索/分页（20/页可配置）
9. 浏览页瀑布流：卡片固定高度 200px，滚动加载 20 张
10. 单图详情页 + 编辑（裁剪比例、色调 slider），编辑前备份，编辑后替换原图、删除缩略图
11. 删除：数据库软删除标记；磁盘文件保留；支持恢复
12. 移动端适配（响应式）

### 1.2 暂不实现但必须预留接口

1. AI 自动识别标签（风景/人物/动物等）
2. MCP 接口：通过大模型对话检索图片

---

## 2. 角色与权限模型

### 2.1 角色定义

- `pending`：注册完成但未被管理员审批；**无任何权限**（除查看自身状态/退出登录）
- `user`：普通用户；允许上传图片、浏览/检索图片、查看详情、编辑自己上传的图片（建议约束），请求删除/恢复自己图片（建议约束）
- `admin`：管理员；拥有全站管理权限（审批、角色变更、全站设置修改、查看/编辑/删除/恢复任意图片）

> 可配置策略：是否允许 user 编辑/删除非自己上传图片。建议默认 **仅可操作自己上传图片**，admin 可操作全部。

### 2.2 权限矩阵（建议）

| 功能                      | pending |       user | admin |
| ------------------------- | ------: | ---------: | ----: |
| 注册                      |      ✅ |         ✅ |    ✅ |
| 登录                      |      ✅ |         ✅ |    ✅ |
| 浏览/检索图片             |      ❌ |         ✅ |    ✅ |
| 上传图片                  |      ❌ |         ✅ |    ✅ |
| 编辑图片                  |      ❌ | ✅(仅自己) |    ✅ |
| 删除/恢复图片             |      ❌ | ✅(仅自己) |    ✅ |
| 审批用户                  |      ❌ |         ❌ |    ✅ |
| 提升/降级角色             |      ❌ |         ❌ |    ✅ |
| 修改全站设置(config.yaml) |      ❌ |         ❌ |    ✅ |

---

## 3. 总体架构设计

### 3.1 逻辑架构（分层）

**前端（React SPA）**

- UI 组件层（MUI）
- 路由层（React Router）
- 状态与数据获取层（React Query/SWR + Axios）
- 权限守卫（Route Guard）

**后端（Connexion + ORM）**

- API 层（OpenAPI 驱动、参数校验、鉴权中间件）
- Service 层（业务逻辑：上传、exif、缩略图、编辑、权限）
- Repository/DAO 层（SQLAlchemy ORM）
- Utils（配置加载、文件路径、图片处理）

**存储**

- DB：SQLite（默认）/ MySQL（可切换）
- 本地文件系统：原图与备份图
- 缩略图：base64 存 DB（不落盘）

### 3.2 物理架构（部署）

- 前端：静态资源（Nginx/静态服务器）
- 后端：Gunicorn + Connexion(Flask) 或 Connexion ASGI（任选其一，建议 Flask 模式更稳定）
- DB：SQLite（开发/轻量）或 MySQL（生产/多人并发）
- 文件卷：图片根目录作为 volume 挂载（重要）

---

## 4. 技术选型与规范

### 4.1 后端

- 框架：Connexion（OpenAPI-first）
- ORM：SQLAlchemy 2.x
- 迁移：Alembic
- 配置：PyYAML（config.yaml）
- 图片处理：Pillow（生成缩略图、裁剪、色调）
- EXIF：Pillow 自带 EXIF + 辅助解析（GPS 等）
- 鉴权：JWT Bearer（简洁，便于前后端分离）
- 密码：bcrypt/argon2（推荐 argon2；实验可 bcrypt）

### 4.2 前端

- React + TypeScript
- UI：@mui/material
- 路由：react-router
- 请求：axios
- 数据缓存：react-query（或 swr）
- 瀑布流：CSS columns 或 MUI ImageList（建议 ImageList + masonry）
- 上传：XHR/axios onUploadProgress（显示进度条）

### 4.3 工程规范（建议强制）

- 后端：black + isort + flake8（或 ruff）+ mypy（可选）
- 前端：eslint + prettier
- Git：提交前 pre-commit
- OpenAPI：作为唯一接口契约，前端用生成器生成 types（openapi-typescript）

---

## 5. 配置设计（config.yaml）

### 5.1 约束

- `config.yaml` 位于**项目根目录**
- 允许后续做“管理界面 + 热重载”，但 **配置不得入库**
- 后端必须支持运行时读取配置（建议缓存 + mtime 检测）

### 5.2 配置项建议结构（示例）

```yaml
port: 6007 # 后端服务启动的端口(提供/api 的端口，访问非api接口页面则返回前端SPA)

site:
  name: '图片管理站'
  favicon_path: './static/favicon.ico' # 管理员更新时可替换该文件

storage:
  root_dir: '/path/to/folder' # 原图根目录
  backup_dir: '/path/to/folder/backup' # 备份根目录（也可由 root_dir + /backup 派生）

upload:
  allowed_exts: 'jpg,png,gif,jpeg'
  max_size_mb: 20

pagination:
  page_size: 20

thumbnail:
  height: 200
  format: 'jpeg' # thumb 统一转 jpeg 以节省体积（也可 png）
  quality: 75

database:
  url: 'sqlite:///./data/app.db' # 默认 sqlite
  # mysql 示例：mysql+pymysql://user:pass@host:3306/imagedb?charset=utf8mb4

security:
  jwt_secret: 'CHANGE_ME'
  jwt_exp_minutes: 120
```

### 5.3 配置热重载策略（实现建议）

- `ConfigLoader` 启动加载一次
- 每次请求前检查 `config.yaml` 的 mtime：

  - 若变更则重新加载并更新内存配置

- 写配置（管理员接口）时：

  - 加文件锁（避免并发写）
  - 写入临时文件后原子替换（避免写一半崩溃）

---

## 6. 文件存储设计

### 6.1 原图落盘路径规则

- 保存路径：`{root_dir}/{year}/{month}/{day}/{hash}.{ext}`

  - `hash`：随机 8 位字符串，字符集 `[a-zA-Z0-9]`
  - `ext`：取上传原文件名后缀（统一转小写），并做白名单校验

- 例：`/data/images/2025/12/20/aB3dE9xQ.jpg`

### 6.2 编辑备份路径规则

- 备份：`{backup_dir}/{year}/{month}/{day}/{hash}_{timestamp}.{ext}`
- timestamp：建议 `YYYYMMDDHHMMSS` 或 Unix 秒
- 例：`/data/images/backup/2025/12/20/aB3dE9xQ_20251220153045.jpg`

### 6.3 文件校验与安全

- 仅允许 `allowed_exts` 中的后缀
- 建议额外校验 MIME/魔数（Pillow open 验证）
- 防止路径穿越：禁止使用用户提供的路径；所有路径由系统拼装
- 上传大小限制：`max_size_mb`

---

## 7. 数据库设计（核心）

> 要求：EXIF 信息、时间、地点、宽、高等信息 **分开建数据库条目**。
> 设计采用“主表 + 拆分子表 + KV EXIF 表”的规范化结构。

### 7.1 ER 概览（文字版）

- users 1—N images（上传者）
- images 1—1 image_dimensions
- images 1—1 image_capture_time
- images 1—1 image_location
- images 1—N image_exif_entries（KV）
- images N—N tags（通过 image_tags）
- images 1—1 image_thumbnail（base64）

### 7.2 表结构定义（建议）

#### 7.2.1 users（用户表）

| 字段          | 类型         | 约束             | 说明               |
| ------------- | ------------ | ---------------- | ------------------ |
| id            | bigint/int   | PK               | 主键               |
| username      | varchar(64)  | unique, not null | 用户名（唯一）     |
| email         | varchar(255) | unique, not null | 邮箱（唯一）       |
| password_hash | varchar(255) | not null         | 密码哈希           |
| role          | varchar(16)  | not null         | pending/user/admin |
| created_at    | datetime     | not null         | 创建时间           |
| last_login_at | datetime     | nullable         | 最后登录           |
| is_active     | bool         | default true     | 可禁用（扩展）     |

校验规则（后端必须做）：

- username 非空、长度合理
- password 长度 >= 6（字节/字符：建议按字符长度处理，同时记录原需求“6 字节以上”，可按 UTF-8 字节长度校验更严谨）
- email 正则格式校验
- username/email 全局唯一

初始化：

- 系统启动时若不存在 admin 用户，则创建：

  - username=admin, password=123456, role=admin, email 可设为 `admin@example.com` 或写入配置

#### 7.2.2 images（图片主表）

| 字段              | 类型         | 约束                          | 说明                                    |
| ----------------- | ------------ | ----------------------------- | --------------------------------------- |
| id                | bigint/int   | PK                            | 图片 ID                                 |
| uploader_id       | bigint/int   | FK(users.id)                  | 上传者                                  |
| original_filename | varchar(255) | not null                      | 原文件名（含后缀）                      |
| ext               | varchar(16)  | not null                      | 后缀（小写）                            |
| hash              | varchar(16)  | not null, index               | 8 位随机 hash（可加唯一约束与日期组合） |
| storage_relpath   | varchar(512) | not null                      | 相对 root_dir 的路径（推荐存相对路径）  |
| size_bytes        | bigint       | not null                      | 文件大小                                |
| mime_type         | varchar(64)  | nullable                      | MIME                                    |
| sha256            | char(64)     | nullable, index               | 可选：去重/校验                         |
| created_at        | datetime     | not null, index               | 上传时间                                |
| updated_at        | datetime     | not null                      | 最近修改（编辑后更新）                  |
| is_deleted        | bool         | not null default false, index | 软删除标记                              |
| deleted_at        | datetime     | nullable                      | 删除时间                                |

> 注意：不建议把 width/height、拍摄时间、地点、exif、thumbnail 都塞进 images 主表，以满足“分开条目”的要求。

#### 7.2.3 image_dimensions（分辨率表）

| 字段     | 类型       | 约束              | 说明 |
| -------- | ---------- | ----------------- | ---- |
| image_id | bigint/int | PK, FK(images.id) | 1:1  |
| width    | int        | not null          | 宽   |
| height   | int        | not null          | 高   |

#### 7.2.4 image_capture_time（拍摄时间表）

| 字段         | 类型        | 约束              | 说明                       |
| ------------ | ----------- | ----------------- | -------------------------- |
| image_id     | bigint/int  | PK, FK(images.id) | 1:1                        |
| taken_at     | datetime    | nullable, index   | EXIF DateTimeOriginal 解析 |
| taken_at_raw | varchar(64) | nullable          | 原始 EXIF 字符串（调试）   |

#### 7.2.5 image_location（地点表）

| 字段      | 类型          | 约束              | 说明                  |
| --------- | ------------- | ----------------- | --------------------- |
| image_id  | bigint/int    | PK, FK(images.id) | 1:1                   |
| latitude  | decimal(10,7) | nullable, index   | 纬度                  |
| longitude | decimal(10,7) | nullable, index   | 经度                  |
| altitude  | decimal(10,2) | nullable          | 海拔                  |
| gps_raw   | text          | nullable          | 原始 GPS 信息（可选） |

#### 7.2.6 image_exif_entries（EXIF KV 表）

| 字段       | 类型         | 约束                 | 说明           |
| ---------- | ------------ | -------------------- | -------------- |
| id         | bigint/int   | PK                   |                |
| image_id   | bigint/int   | FK(images.id), index |                |
| exif_key   | varchar(128) | not null, index      | 如 Model、Make |
| exif_value | text         | nullable             | 值             |

> 说明：EXIF 很多且结构不一，用 KV 最稳；常用字段（时间/地点/宽高）已拆表做“结构化可索引”。

#### 7.2.7 tags（标签表）

| 字段       | 类型        | 约束             | 说明                         |
| ---------- | ----------- | ---------------- | ---------------------------- |
| id         | bigint/int  | PK               |                              |
| name       | varchar(64) | unique, not null | 标签名（唯一）               |
| source     | varchar(16) | not null         | `custom`/`exif`/`ai`（预留） |
| created_at | datetime    | not null         |                              |

#### 7.2.8 image_tags（图片-标签关联表）

| 字段       | 类型       | 约束     | 说明 |
| ---------- | ---------- | -------- | ---- |
| image_id   | bigint/int | PK(FK)   |      |
| tag_id     | bigint/int | PK(FK)   |      |
| created_at | datetime   | not null |      |

> 自定义标签是 list：前端提交一个数组；后端做 upsert：不存在则创建 tags，再维护 image_tags。

#### 7.2.9 image_thumbnail（缩略图表）

| 字段        | 类型          | 约束              | 说明                                                 |
| ----------- | ------------- | ----------------- | ---------------------------------------------------- |
| image_id    | bigint/int    | PK, FK(images.id) | 1:1                                                  |
| format      | varchar(16)   | not null          | jpeg/png                                             |
| height      | int           | not null          | 缩略图高度（默认 200）                               |
| width       | int           | not null          | 生成后宽度                                           |
| data_base64 | longtext/text | not null          | base64（不含 data:image 前缀或含前缀二选一，需统一） |
| created_at  | datetime      | not null          |                                                      |

> “通过 mysql 的形式提供”：理解为从 DB 读取缩略图数据给前端，而不是从文件系统。

---

## 8. 关键业务流程设计

### 8.1 注册与审批

1. 用户提交注册信息（username/email/password）
2. 后端校验：长度、email 格式、唯一性
3. 创建用户 role=`pending`
4. pending 用户可登录，但访问图片相关接口将返回 403（无权限）
5. 管理员在“用户审批”页面看到 pending 列表，批准后 role=`user`

### 8.2 上传图片（单张）

1. 前端 multipart 上传
2. 后端鉴权：必须 role=user/admin
3. 校验后缀白名单 + 文件大小 + Pillow 打开验证
4. 生成 `hash`，按日期目录写入磁盘（原图）
5. 读取图片尺寸 -> 写 image_dimensions
6. 解析 EXIF：

   - 写 image_exif_entries（KV 全量或挑部分）
   - 解析拍摄时间 -> image_capture_time
   - 解析 GPS -> image_location
   - 根据 EXIF 生成标签（如相机型号/镜头/拍摄日期等策略可配置）-> tags + image_tags（source=exif）

7. 生成缩略图（高=200，等比缩放）-> base64 写 image_thumbnail
8. 返回图片 ID + 详情链接 + 直链（可选）

### 8.3 浏览/检索（分页+标签）

- GET /images 按 created_at 倒序
- 支持 query：

  - page / page_size（page_size 受 config 限制）
  - tags=tag1,tag2（交集或并集策略需确定，建议默认 AND，可加 mode=any/all）
  - include_deleted（admin 可用）

- 响应返回：每张图片的基础信息 + thumbnail_base64（用于瀑布流）

### 8.4 编辑（裁剪/色调）

1. 前端在单图页提交裁剪比例或 hue 值
2. 后端鉴权：user(仅自己) 或 admin
3. 编辑前备份原图到 backup_dir
4. Pillow 处理原图并覆盖原路径
5. 删除 image_thumbnail（或置空），让前端刷新后重新生成
6. updated_at 更新
7. 返回新的缩略图（可选：立即重建并返回，体验更好）

### 8.5 删除与恢复

- 删除：只更新 images.is_deleted=true、deleted_at=now；其余信息不删，磁盘文件保留
- 恢复：is_deleted=false、deleted_at=null

---

## 9. OpenAPI 接口设计（用于 Connexion）

### 9.1 通用约定

- Base URL：`/api`
- 鉴权：`Authorization: Bearer <JWT>`
- 时间字段：ISO8601
- 错误响应统一格式：

```json
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "email format invalid",
    "details": { "field": "email" }
  }
}
```

常见错误码：

- 400 VALIDATION_ERROR
- 401 UNAUTHORIZED
- 403 FORBIDDEN
- 404 NOT_FOUND
- 409 CONFLICT（用户名/邮箱重复）
- 413 PAYLOAD_TOO_LARGE
- 415 UNSUPPORTED_MEDIA_TYPE（不允许的后缀）
- 500 INTERNAL_ERROR

### 9.2 鉴权与用户

#### 注册

- `POST /api/auth/register`
- body:

```json
{ "username": "u1", "email": "u1@test.com", "password": "123456" }
```

- resp:

```json
{ "id": 12, "role": "pending" }
```

#### 登录

- `POST /api/auth/login`
- body:

```json
{ "username": "u1", "password": "123456" }
```

- resp:

```json
{ "access_token": "xxx", "token_type": "Bearer", "expires_in": 7200, "role": "pending" }
```

#### 获取当前用户

- `GET /api/users/me`
- resp:

```json
{ "id": 12, "username": "u1", "email": "u1@test.com", "role": "user" }
```

#### 修改密码（用户设置）

- `PATCH /api/users/me/password`
- body:

```json
{ "old_password": "123456", "new_password": "abcdef" }
```

### 9.3 管理员：用户审批与角色管理

- `GET /api/admin/users?role=pending&page=1&page_size=20`
- `POST /api/admin/users/{user_id}/approve`（pending -> user）
- `POST /api/admin/users/{user_id}/role` body `{ "role": "admin" | "user" }`

### 9.4 图片：上传/浏览/详情/检索

#### 上传（单张；多张由前端并行多次调用）

- `POST /api/images`
- Content-Type: `multipart/form-data`

  - file: 图片文件
  - tags（可选）：`tag1,tag2`（或用 JSON 字段，视实现）

- resp（建议返回“复制链接”需要的信息）：

```json
{
  "id": 1001,
  "view_url": "/images/1001",
  "api_url": "/api/images/1001",
  "file_url": "/api/images/1001/file"
}
```

#### 列表/检索（瀑布流）

- `GET /api/images?page=1&page_size=20&tags=cat,dog&tag_mode=any`
- resp：

```json
{
  "page": 1,
  "page_size": 20,
  "total": 341,
  "items": [
    {
      "id": 1001,
      "created_at": "2025-12-20T10:00:00Z",
      "thumbnail": {
        "format": "jpeg",
        "data_base64": "...."
      },
      "tags": ["custom:cat", "exif:Canon"],
      "is_deleted": false
    }
  ]
}
```

> 性能建议：thumbnail base64 会增大 payload，但每次 20 张可接受；后续可优化为单独的 `/thumbnail` 端点并懒加载。

#### 单图详情（元数据）

- `GET /api/images/{id}`
- resp：

```json
{
  "id": 1001,
  "uploader": { "id": 1, "username": "u1" },
  "storage_relpath": "2025/12/20/aB3dE9xQ.jpg",
  "dimensions": { "width": 4032, "height": 3024 },
  "capture_time": { "taken_at": "2023-01-02T03:04:05Z" },
  "location": { "latitude": 31.2304, "longitude": 121.4737 },
  "exif": [{ "key": "Model", "value": "iPhone" }],
  "tags": ["cat", "travel"],
  "is_deleted": false
}
```

#### 获取原图（用于详情页大图展示）

- `GET /api/images/{id}/file`
- resp：`image/*` 流式输出（send_file）
- 支持 Range（可选优化）

#### 获取缩略图（可选接口）

- `GET /api/images/{id}/thumbnail`
- resp：

```json
{ "format": "jpeg", "data_base64": "..." }
```

### 9.5 图片标签管理

- `PUT /api/images/{id}/tags`
- body：

```json
{ "tags": ["cat", "travel"] }
```

### 9.6 图片编辑（裁剪/色调）

#### 裁剪

- `POST /api/images/{id}/edit/crop`
- body（比例，0~1 或 0~100 二选一，建议 0~100 更贴近需求）：

```json
{ "top": 0, "bottom": 0, "left": 10, "right": 10 }
```

#### 色调

- `POST /api/images/{id}/edit/hue`
- body（slider 值，建议 -180~180 或 -100~100）：

```json
{ "delta": 20 }
```

响应建议：返回新的 thumbnail（立即重建）或返回成功后由前端刷新详情接口。

### 9.7 删除与恢复

- `DELETE /api/images/{id}`（软删除）
- `POST /api/images/{id}/restore`

### 9.8 全站设置（管理员，写 config.yaml）

- `GET /api/admin/config`
- `PUT /api/admin/config`

  - 可包含：site_name、favicon 上传（multipart）或 favicon_base64
  - 后端写入 config.yaml 并触发 reload

---

## 10. 后端详细模块设计（可直接拆任务）

### 10.1 目录结构建议

```
backend/
  app.py
  openapi.yaml
  config.yaml
  src/
    api/                # Connexion handlers
      auth.py
      users.py
      admin.py
      images.py
      config.py
    core/
      config_loader.py
      auth_middleware.py
      permissions.py
      errors.py
      logging.py
    models/             # SQLAlchemy models
      user.py
      image.py
      exif.py
      tag.py
      thumbnail.py
    services/
      auth_service.py
      user_service.py
      image_service.py
      exif_service.py
      thumbnail_service.py
      edit_service.py
      config_service.py
    repositories/
      user_repo.py
      image_repo.py
      tag_repo.py
    utils/
      file_paths.py
      image_ops.py
  migrations/           # Alembic
  tests/
```

### 10.2 核心服务职责

#### AuthService

- register：校验 + 创建 pending 用户
- login：校验密码 + 签发 JWT
- password hashing：bcrypt/argon2

#### UserService（含 Admin 操作）

- approve_user：pending -> user
- set_role：user<->admin
- change_password：校验旧密码

#### ImageService

- validate_upload（ext、size、Pillow 验证）
- save_file（生成 hash、目录、写盘）
- create_image_record（images 主表）
- extract_metadata：

  - dimensions
  - capture_time
  - location
  - exif_entries

- tag management（exif tag 与 custom tag）
- list_images（分页/过滤/排序）
- get_image_file（send_file）
- soft_delete / restore

#### ThumbnailService

- generate_thumbnail(image_path, height=200) -> (format, width, height, base64)
- upsert_thumbnail(image_id, base64)
- invalidate_thumbnail(image_id)

#### EditService

- backup_original(image_path) -> backup_path
- crop(image_path, ratios)
- hue_adjust(image_path, delta)
- after_edit：invalidate_thumbnail + update updated_at +（可选）rebuild thumbnail

#### ConfigService

- load config with caching/mtime
- write config (admin) with atomic replace + file lock

---

## 11. 前端界面与交互设计（React + MUI）

### 11.1 路由规划

- `/register` 注册页
- `/login` 登录页
- `/upload` 上传页（user/admin）
- `/browse` 浏览页（瀑布流，user/admin）
- `/images/:id` 单图详情 + 编辑（user/admin）
- `/settings` 设置页

  - 用户设置：改密码
  - 全站设置（admin）：站点名称、favicon

### 11.2 全局状态

- auth：token、当前用户信息 role
- axios 拦截器：自动带 Authorization
- Route Guard：

  - pending：只允许访问 settings/me、logout 等；访问 browse/upload 返回引导提示“等待管理员审批”
  - user/admin：正常使用

### 11.3 注册页面

- 表单：username/email/password/confirm
- 实时校验：密码长度>=6、email 格式
- 提交后提示：“已提交注册，等待管理员审批”
- 可跳转登录

### 11.4 登录页面

- username + password
- 登录成功后：

  - role=pending：跳转到提示页或 settings 显示状态
  - role=user/admin：跳转 browse

### 11.5 上传页面（重点）

- 支持：

  - 点击选择文件（input[type=file] multiple accept=…）
  - 拖拽上传（Dropzone）

- 多文件：逐个发起 `POST /api/images`（可并发，默认并发数建议 3~5）
- 每个文件展示：

  - 文件名
  - 进度条（axios onUploadProgress）
  - 成功后显示：“复制图片链接”按钮（复制 view_url 或 file_url）

- 上传完成后可给每张图片设置自定义 tags（可选增强：上传时就带 tags）

### 11.6 浏览图片页面（瀑布流）

- 瀑布流卡片：

  - 固定高度 200px（缩略图高度=200，宽自适应）
  - placeholder：Skeleton

- 加载策略：

  - 初始加载 20 张：`GET /api/images?page=1`
  - 滚动到底部自动加载下一页

- 检索区：

  - 标签筛选输入（autocomplete，来源 `GET /api/tags` 可选）
  - tag_mode：任意/全部

- 点击卡片进入详情页

### 11.7 单图详情页 + 编辑

- 展示：

  - 大图（GET /file）
  - 基本信息：尺寸、时间、地点、EXIF 列表、标签

- 编辑区（按钮弹出表单）：

  - 裁剪：四个输入框 top/bottom/left/right（默认 0%）
  - 色调：slider

- 提交编辑后：

  - 显示 loading
  - 成功后刷新（重新拉详情与缩略图）

- 删除/恢复按钮：

  - user：仅对自己图片显示
  - admin：对所有显示
  - 删除为软删除；详情页应显示 “已删除” 状态并提供恢复（admin 或拥有者）

### 11.8 设置页面

- 用户设置：

  - 修改密码（旧密码/新密码/确认）

- 全站设置（仅 admin）：

  - 站点名称
  - favicon 上传（选择文件后提交）
  - 提交后刷新页面标题/图标（前端可读取 `/api/admin/config` 或 `/api/site`）

---

## 12. 安全设计

### 12.1 密码与登录

- 密码哈希存储（bcrypt/argon2）
- JWT：

  - 包含 user_id、role
  - 过期时间 config 可配

- 重要：默认 admin/123456 风险高，建议首次登录提示修改密码（可作为增强）

### 12.2 鉴权与鉴权中间件

- Connexion 支持 security scheme：在 OpenAPI 声明 BearerAuth
- middleware 校验 token -> 注入 request context（user_id/role）
- 权限装饰器 `require_role(min_role)` 与 `require_owner_or_admin(image_id)`

### 12.3 上传安全

- 后缀白名单 + Pillow 打开验证
- 限制大小
- 生成随机文件名，杜绝目录穿越
- 建议对原图输出设置合适的 Content-Disposition，避免 XSS（尤其 svg 不允许上传）

---

## 13. 性能与可维护性

- 列表接口只返回必要字段；缩略图 base64 体积可控（height=200 + jpeg quality）
- 数据库索引：

  - images(created_at, is_deleted)
  - image_tags(image_id, tag_id)
  - tags(name)

- 缩略图失效：编辑后删除 thumbnail 行，访问时自动重建（或编辑后立即重建）
- 日志：记录上传/编辑/删除等操作（建议额外 audit 表或结构化日志）

---

## 14. 测试设计（可直接拆给 QA/开发）

### 14.1 后端测试（pytest）

- Auth

  - 注册校验：密码长度、email 格式、用户名重复、邮箱重复
  - 登录成功/失败

- 权限

  - pending 访问 /images -> 403
  - user 上传成功
  - user 编辑他人图片 -> 403（若启用“仅自己”策略）

- 上传

  - 不允许后缀 -> 415
  - 非图片文件伪装 -> 415/400

- EXIF

  - 有/无 EXIF 的图片都能入库
  - GPS 解析正确（可用固定样例图）

- 编辑

  - 裁剪比例边界：0/100、非法值
  - 编辑后备份文件存在
  - 编辑后缩略图被删除并可重建

- 软删除/恢复

  - 删除后列表不返回（默认）
  - admin include_deleted 可看到
  - 恢复后可再浏览

### 14.2 前端测试（建议）

- 基础 e2e（Playwright/Cypress）：

  - 注册 -> pending 提示
  - admin 审批 -> user 上传 -> 浏览 -> 详情编辑 -> 删除恢复

- 组件测试（可选）：上传进度条、瀑布流加载、tag filter

---

## 15. 部署与运维建议（最小可用）

### 15.1 Docker Compose（建议）

- services：

  - backend
  - frontend（或 nginx 托管）
  - mysql（可选）

- volumes：

  - `./data`（sqlite）
  - `/path/to/folder`（图片目录）
  - `./config.yaml`（配置）

### 15.2 数据迁移

- 统一用 Alembic
- SQLite -> MySQL：按同一套 migration 初始化

---

## 16. 扩展接口预留设计

### 16.1 AI 标签（预留）

- tags.source 增加 `ai`
- 新接口（未来实现）：

  - `POST /api/images/{id}/ai-analyze`：异步任务生成标签
  - `GET /api/images/{id}/ai-status`

### 16.2 MCP 接口（预留）

- 预留检索能力：现有 `GET /api/images` 已支持 tags/filter
- 未来新增：

  - `/api/mcp/search`：把自然语言转为结构化查询（由大模型或规则引擎）

---

## 17. 研发任务拆分清单（可直接分配）

下面按“可并行”拆分，给到明确产出物（Definition of Done）。

---

### 17.1 后端任务（Backend）

**B1. 项目骨架与基础设施**

- 产出：

  - Connexion 项目骨架 + `openapi.yaml`
  - SQLAlchemy + Alembic 初始化
  - config.yaml 加载器（mtime reload）
  - 统一错误响应格式
  - 日志（结构化、请求 id）

- DoD：

  - 服务可启动，/api/health 返回 OK（可加）

**B2. 用户与鉴权**

- 产出：

  - users 表 + admin 初始化逻辑（无则创建 admin/123456）
  - 注册/登录/JWT 校验
  - /users/me 与改密
  - role 权限装饰器

- DoD：

  - 注册后 role=pending
  - pending 登录后访问图片接口 403

**B3. 管理员用户审批与角色管理**

- 产出：

  - pending 列表接口
  - approve 接口
  - set_role 接口

- DoD：

  - admin 可将 pending -> user
  - admin 可 user<->admin

**B4. 图片上传与落盘**

- 产出：

  - 上传接口（multipart）
  - ext 白名单校验（来自 config.yaml）
  - 文件写入 `{year}/{month}/{day}/{hash}.{ext}`
  - images 主表写入

- DoD：

  - 支持单文件上传成功
  - 目录结构符合要求

**B5. EXIF/元数据入库**

- 产出：

  - dimensions/capture_time/location/exif_entries 表写入
  - 基于 EXIF 生成部分标签（source=exif）

- DoD：

  - 数据库能查到结构化字段与 KV EXIF

**B6. 缩略图生成与存储**

- 产出：

  - 生成 height=200 的 thumbnail
  - base64 存 image_thumbnail
  - 列表接口返回 thumbnail

- DoD：

  - browse 页能直接展示缩略图

**B7. 图片检索与列表分页**

- 产出：

  - GET /images 支持分页、tags 过滤、排序
  - page_size 默认来自 config.yaml

- DoD：

  - 每页最多 20（默认），可配置更改生效

**B8. 单图详情与文件流**

- 产出：

  - GET /images/{id}（聚合返回所有元数据）
  - GET /images/{id}/file（流式返回原图）

- DoD：

  - 前端可展示大图与信息

**B9. 编辑能力（裁剪/色调）+ 备份**

- 产出：

  - crop/hue 接口
  - 编辑前备份到 backup 路径
  - 编辑后覆盖原图，删除缩略图记录

- DoD：

  - 编辑后刷新能看到变化
  - backup 文件存在

**B10. 软删除与恢复**

- 产出：

  - DELETE /images/{id}，POST /restore
  - 列表默认不返回 deleted
  - admin 可 include_deleted（可选）

- DoD：

  - 删除后不可见；恢复后可见

**B11. 全站设置（config.yaml 写入）**

- 产出：

  - GET/PUT admin/config
  - 更新 site.name 和 favicon（文件存 static）
  - 原子写 config.yaml + reload

- DoD：

  - 修改后前端刷新可看到变化

---

### 17.2 前端任务（Frontend）

**F1. 项目初始化与基础设施**

- 产出：

  - React+TS+MUI 项目
  - Axios client + auth token 注入
  - React Router 路由与 Guard

- DoD：

  - 未登录跳转 login；pending 有提示页

**F2. 注册页**

- 产出：表单校验 + 提交 + pending 提示
- DoD：与后端 register 对齐

**F3. 登录页**

- 产出：登录获取 token + 保存 + 获取 me
- DoD：按 role 跳转正确

**F4. 上传页**

- 产出：

  - 选择/拖拽多文件
  - 并行上传 + 单文件进度条
  - 上传完成后“复制链接”按钮

- DoD：可连续上传多张并展示进度

**F5. 浏览页（瀑布流 + 无限滚动 + 标签过滤）**

- 产出：

  - 瀑布流展示 thumbnail（200px 高）
  - Skeleton placeholder
  - 滚动加载下一页
  - tags filter UI

- DoD：可稳定加载/过滤

**F6. 单图详情页 + 编辑**

- 产出：

  - 展示大图、EXIF、时间地点、标签
  - 编辑弹窗：crop 表单 + hue slider
  - 删除/恢复按钮

- DoD：编辑后自动刷新展示最新图

**F7. 设置页**

- 产出：

  - 改密码
  - admin：站点名 + favicon 上传

- DoD：保存成功提示

---

### 17.3 测试与交付（QA/DevOps）

**Q1. API 合约测试**

- 基于 openapi.yaml 做 smoke test（或 Postman collection）

**Q2. E2E 流程测试**

- 覆盖：注册 -> 审批 -> 上传 -> 浏览 -> 编辑 -> 删除 -> 恢复

**D1. Docker 化与一键启动**

- docker-compose：sqlite + backend + frontend（可选 mysql profile）
- volume 映射图片目录与 config.yaml

---

## 18. 关键实现细节决策（避免开发分歧）

1. **标签过滤逻辑**：默认 `tag_mode=any`（并集）更符合用户预期；同时支持 `all`（交集）。
2. **thumbnail base64 格式**：统一存“不带 data:image 前缀”的纯 base64，响应时由前端拼 `data:image/jpeg;base64,`。
3. **pending 权限**：除 `/auth/*`、`/users/me`、`/users/me/password` 外，一律 403。
4. **编辑后缩略图策略**：编辑接口执行完成后立即重建缩略图并返回（体验更好）；或仅 invalidate 由下次请求重建（二选一，建议立即重建）。
5. **图片操作权限**：user 默认只能编辑/删除自己上传的图片；admin 全部可操作。

---

如果你希望我进一步“落地到可直接开工的程度”，我可以在下一步把 **openapi.yaml 的完整草案**（含 schema、security、所有 endpoint 的 request/response 定义）也一并写出来，并给出后端每个 handler 的函数签名与模块骨架（这样前后端就能完全按契约并行开发）。
