<!--
任务：根据 pixhost 项目真实功能/接口/数据库编写《项目报告》。
方案：参考 openapi.yaml、docs/设计文档.md、backend/src/models 与前端页面实现，按“背景-需求-架构-数据库-接口-界面-附录”结构整理并突出亮点。
-->

# 图片管理网站 项目报告

## 目 录

一、项目背景  
二、系统需求分析  
2.1 功能性需求分析  
2.2 非功能性需求分析  
2.2.1 性能需求  
2.2.2 输入输出需求  
2.2.3 数据管理需求  
三、系统技术选型与架构设计  
3.1 设计目标与关键约束  
3.2 实现补充（当前交付对照）  
3.3 需求范围与预留接口  
3.4 角色与权限模型  
3.5 逻辑架构（分层）  
3.6 物理架构（部署）  
3.7 系统总体架构图  
3.8 前端架构图  
3.9 后端架构图  
3.10 项目技术选型  
3.11 工程规范（建议强制）  
3.12 配置设计（config.yaml）  
3.13 文件存储设计  
3.14 关键业务流程设计  
3.15 OpenAPI 接口约定  
3.16 后端模块设计与职责  
3.17 前端界面与交互设计  
3.18 安全设计  
3.19 性能与可维护性  
3.20 测试设计  
3.21 部署与运维建议  
3.22 扩展接口预留设计  
3.23 研发任务拆分清单  
3.24 关键实现细节决策  
3.25 图片详情页分栏样式与操作区规范  
3.26 系统运行环境  
3.26.1 软件环境  
3.26.2 硬件环境  
四、数据库设计与 ER 图  
4.1 数据表设计  
4.2 ER 图  
五、系统接口设计  
5.1 用户与认证接口  
5.2 管理员接口  
5.3 图片与标签接口  
5.4 编辑、收藏与 AI 接口  
5.5 MCP 检索接口  
六、系统界面原型  
七、附录  

---

## 一、项目背景

pixhost 是一个面向个人与小团队的图片管理网站，采用前后端分离架构与 OpenAPI 作为接口契约，支持图片上传、分类检索、详情浏览、在线编辑以及 AI 辅助标签与检索等能力。系统目标是让图片“可管理、可检索、可分享”，并在性能、交互和可维护性上达到教学项目的完整交付标准。

**项目亮点**
- OpenAPI 驱动的前后端协作，接口可追溯、类型可生成。
- 角色权限明确：pending/user/admin，管理员审批与角色管理完整闭环。
- 图片原始文件按日期+随机 hash 落盘，编辑自动备份，删除为软删除可恢复。
- EXIF 信息、拍摄时间、地点、分辨率、缩略图均独立建表，数据结构化可索引。
- 缩略图以 base64 入库，配合最大边/体积限制，保证列表性能与加载体验。
- 瀑布流稳定分栏 + 列表视图切换，移动端自适应；支持拖拽/多文件/粘贴上传与进度展示。
- 收藏系统 + 首页收藏轮播；直链复制与公开图片访问。
- Qwen3-VL AI 标注与 MCP 检索接入，支持“帮我找图”智能检索。
- 配置文件 config.yaml 热加载，站点名/允许后缀/分页大小/favicon/外链基址可在线更新。

---

## 二、系统需求分析

### 2.1 功能性需求分析

1. **用户与权限**
   - 注册、登录、JWT 鉴权。
   - 角色：pending/user/admin；pending 无权限，需管理员审批。
   - 管理员可审批用户、升降级权限。
2. **图片上传与存储**
   - PC/移动端上传，支持拖拽、多文件并行、粘贴上传。
   - 图片原文件保存至 `{root}/{year}/{month}/{day}/{hash}.{ext}`。
   - 允许后缀由 `config.yaml` 配置。
3. **图片元数据解析**
   - EXIF 自动解析：拍摄时间、GPS、分辨率。
   - EXIF 信息以独立数据库条目保存，满足“元数据拆表”要求。
4. **标签体系**
   - 自定义标签（list）与 EXIF/AI 标签统一管理。
   - 标签来源区分 custom/exif/ai，便于检索与统计。
5. **浏览与检索**
   - 瀑布流浏览、列表视图切换。
   - 按标签筛选，支持 tag_mode=any/all。
   - 分页加载，默认 20 张/页。
6. **详情与编辑**
   - 单图详情页展示元数据与原图。
   - 裁剪与色调调整，编辑前备份、编辑后刷新缩略图。
   - 提供编辑预览接口。
7. **删除与恢复**
   - 软删除（is_deleted 标记），磁盘文件保留。
   - 支持恢复已删除图片。
8. **收藏与分享**
   - 收藏/取消收藏，收藏列表与轮播展示。
   - 公开直链 `/images/...` 与一键复制链接。
9. **AI 功能**
   - AI 生成标签（Qwen3-VL），失败信息回传前端。
   - MCP 检索：输入文本描述，AI 选择标签并返回匹配图片。
10. **配置管理**
    - 管理员可更新站点名称、favicon、允许后缀、分页大小、外链基址。
    - 配置保存于 `config.yaml`，不入库。

### 2.2 非功能性需求分析

#### 2.2.1 性能需求
- 列表分页默认 20 条，缩略图 base64 限制最大边与体积（max_edge=100, max_bytes=100KB）。
- 图片列表与标签检索优先走索引字段（created_at、hash、is_deleted、is_favorite、exif_key）。
- 前端瀑布流按最矮列分配，减少重排；缩略图先行加载，完整图加载后替换，避免长时间白屏。

#### 2.2.2 输入输出需求
- 输入：图片文件（multipart）、标签数组、编辑参数（裁剪/色调）、AI 检索文本。
- 输出：JSON 元数据、base64 缩略图、图片流文件、公开直链、AI 标签与检索结果。
- 对上传文件做后缀白名单与大小校验，避免无效文件写盘。

#### 2.2.3 数据管理需求
- 配置数据保存在 `config.yaml`，支持热加载，不进入数据库。
- 图片原文件与备份按日期分目录存储，保证可追溯与回滚。
- 数据库支持 SQLite（默认）与 MySQL，使用 ORM 统一管理。
- 遵循 “Let it crash” 原则，关键流程优先暴露错误，避免吞错。

---

## 三、系统技术选型与架构设计

<!--
任务：在架构设计部分补全 docs/设计文档.md 中的所有设计要点。
方案：按设计文档的章节结构分节汇总关键决策，并保留原有架构图与运行环境信息。
-->

### 3.1 设计目标与关键约束

- 目标：前后端分离 + OpenAPI 契约驱动，保证接口一致、可测试与可扩展。
- 初始化必须创建管理员账号：`admin / 123456`。
- 用户角色：`pending/user/admin`，其中 `pending` 无任何权限。
- 图片原文件保存路径：`{root}/{year}/{month}/{day}/{hash}.{ext}`。
- 编辑备份路径：`{root}/backup/{year}/{month}/{day}/{hash}_{timestamp}.{ext}`。
- 配置文件 `config.yaml` 位于项目根目录，**禁止入库**。

### 3.2 实现补充（当前交付对照）

- 接口契约：`openapi.yaml` 位于项目根目录，已关闭 swagger-ui，`bearerAuth` 通过 `x-bearerInfoFunc=src.core.security.bearer_info` 校验 JWT。
- 鉴权：Connexion 中间件 + JWT；前后端均强制“仅上传者本人可编辑/删除”，管理员不越权；`pending` 仅可查看个人信息。
- 缩略图：最大边 100px，迭代压缩确保体积 ≤100KB（`thumbnail.max_edge/max_bytes/quality` 可调）。
- 配置：`config.yaml` 热加载；管理员可更新站点名/上传后缀/分页大小/favicon，配置不入库。
- 存储：原图与备份按日期 + 8 位随机 hash 落盘，hash 冲突会重算；缩略图 base64 入库。
- 缺失文件处理：列表/缩略图生成前检查源文件存在性，缺失只 warning 并跳过，接口不中断，补齐后自动恢复显示。
- 迁移：提供 `migration/export_upload_history.py` 导出上传历史 JSONL（默认 `data/PicUploader.db` -> `data/pic_uploader_history.jsonl`）。
- 前端：React + MUI + React Query；瀑布流 1/2/3/4/5 列响应式，列宽固定、按最矮列落位（同高取最左，分配顺序稳定）；缩略图加载即 Grow 出现，完整图加载后无缝覆盖；列数变更时重排并动画展示；卡片默认浅阴影、hover 时阴影增强；复制按钮与标签 hover 出现（标签贴左下角）；卡片高度限制 100-600px，超出则等比缩放；支持列表视图（表格背景透明）；上传支持拖拽/多文件并行/ Ctrl+V 粘贴与复制直链。
- 前端图片加载：瀑布流/列表/详情使用 `public_url` 的路径部分（`/images/{year}/{month}/{day}/{filename}`）展示，Vite dev 代理 `/images` 到后端；复制链接时统一补全 hostname，直链基于年月日+hash。
- 前端开发：Vite dev/preview 默认绑定 `0.0.0.0`，允许的 host 列表加入 `memset0.cn`。
- 详情页：移除“加载中...”文本，基于元数据尺寸展示等比例骨架；先显示缩略图，完整图加载后淡入替换。
- 浏览页视图切换（瀑布流/列表）重置分页并重新拉取，避免切换卡顿。
- 收藏：images 表新增 `is_favorite`；新增收藏/取消收藏接口 `/api/images/{id}/favorite` 与收藏列表 `/api/images/favorites`。
- 收藏：详情页收藏按钮；浏览页顶部 16:9 收藏轮播（无收藏不展示），默认 5 秒切换，支持上一张/下一张，居中两侧半透明并带 3D 纵深过渡。
- 数据：缩略图表记录 `size_bytes`，生成缩略图同步写入；编辑后重置缩略图并刷新 `size_bytes`，列表视图稳定显示原始文件名与大小。
- AI 标注：接入 Qwen3-VL，`/api/images/{id}/ai-analyze` 生成标签（source=ai）并入库，详情页提供“AI 生成标签”按钮。
- AI 标注失败：详情页展示后端错误信息，便于定位配置/权限/额度问题。
- AI 标注自动化：`qwen.auto_tag_on_upload` 控制上传时自动生成标签，失败仅后端 warning，默认关闭。
- AI 检索：新增 `/api/mcp/search`，从标签库生成 prompt，由模型选出 5 个标签并排序检索；前端“帮我找图”横向展示前 5 张并显示模型输出，等待时展示搜索动画。
- UI/UX：全局卡片标题（h6）统一加粗（fontWeight: 700）。
- UI/UX：右下角圆形“回到顶部”按钮，下滑后 Grow 出现，点击使用自定义 requestAnimationFrame + easeOut 平滑回顶。
- UI/UX：浏览页瀑布流卡片 hover 时保持等比覆盖并在现有缩放基础上平滑放大约 4%。
- UI/UX：全局滚动条使用 `scrollbar-gutter: stable`，细窄圆角浅灰样式，hover 略加深，避免布局跳动。

### 3.3 需求范围与预留接口

**必须实现**
1. 注册、登录、权限体系（pending/user/admin）。
2. 管理员审批用户、提升/降级权限。
3. 图片上传（PC/移动端），并发上传、进度条展示。
4. 图片落盘存储（日期目录 + 随机 8 位 hash）。
5. EXIF 解析与自动标签（时间、地点、分辨率等）。
6. 自定义标签（list）。
7. 缩略图生成并以 base64 入库。
8. 图片信息入库、查询、检索与分页（默认 20/页）。
9. 瀑布流浏览：列宽固定、最矮列落位、Grow 动画、滚动加载。
10. 单图详情与编辑（裁剪/色调），编辑前备份。
11. 软删除与恢复。
12. 移动端适配（响应式）。

**预留接口**
- MCP 接口：已实现“帮我找图”文本检索，后续可扩展多模态对话检索。

### 3.4 角色与权限模型

角色定义：
- `pending`：注册后待审批，仅可查看自身状态与退出。
- `user`：上传、浏览、检索、查看详情、编辑自己上传图片（建议限制）。
- `admin`：全站管理与审批、角色变更、全站设置修改。

权限矩阵（建议）：

| 功能 | pending | user | admin |
| --- | ---: | ---: | ---: |
| 注册 | ✅ | ✅ | ✅ |
| 登录 | ✅ | ✅ | ✅ |
| 浏览/检索图片 | ❌ | ✅ | ✅ |
| 上传图片 | ❌ | ✅ | ✅ |
| 编辑图片 | ❌ | ✅(仅自己) | ✅ |
| 删除/恢复图片 | ❌ | ✅(仅自己) | ✅ |
| 审批用户 | ❌ | ❌ | ✅ |
| 提升/降级角色 | ❌ | ❌ | ✅ |
| 修改全站设置(config.yaml) | ❌ | ❌ | ✅ |

### 3.5 逻辑架构（分层）

**前端（React SPA）**
- UI 组件层（MUI）
- 路由层（React Router）
- 状态/数据层（React Query + Axios）
- 权限守卫（Route Guard）

**后端（Connexion + ORM）**
- API 层（OpenAPI 驱动、参数校验、鉴权中间件）
- Service 层（上传、EXIF、缩略图、编辑、权限）
- Repository/DAO 层（SQLAlchemy ORM）
- Utils（配置加载、文件路径、图片处理）

**存储**
- DB：SQLite（默认）/ MySQL（可切换）
- 文件系统：原图 + 备份
- 缩略图：base64 入库

### 3.6 物理架构（部署）

- 前端：静态资源（Nginx/静态服务器）。
- 后端：Gunicorn + Connexion(Flask) 或 Connexion ASGI。
- DB：SQLite（开发/轻量）或 MySQL（生产/多人并发）。
- 文件卷：图片根目录作为 volume 挂载。

### 3.7 系统总体架构图

```text
┌──────────────┐       /api, /images       ┌──────────────────┐
│  Web Client  │ ───────────────────────▶ │ Connexion API    │
│ React + MUI  │ ◀─────────────────────── │ JWT/Auth Service │
└──────────────┘                           ├──────────────────┤
                                           │ SQLAlchemy ORM   │
                                           │ Pillow Image Ops │
                                           ├────────┬─────────┤
                                           │        │
                                           ▼        ▼
                                   SQLite/MySQL  File Storage
                                           │        │
                                           ▼        ▼
                                         Qwen3-VL  Backup Files
```

### 3.8 前端架构图

```text
React Router
   │
Pages (Login/Register/Upload/Browse/Detail/Settings/Search)
   │
Components (Waterfall, FavoriteCarousel, Dialogs)
   │
API Client (Axios) ── React Query Cache
```

### 3.9 后端架构图

```text
OpenAPI.yaml
   │
Connexion Handlers (api/*.py)
   │
Services (auth/image/tag/config/ai)
   │
Repositories + ORM Models
   │
SQLite/MySQL + File Storage
```

### 3.10 项目技术选型

| 模块 | 技术选型 | 说明 |
| --- | --- | --- |
| 前端 | React + TypeScript + Vite | SPA 架构，开发体验与构建速度兼顾 |
| UI | Material UI (MUI) | 组件化与响应式支持 |
| 数据请求 | Axios + React Query | 数据缓存与自动重试 |
| 后端 | Python + Connexion | OpenAPI 驱动接口 |
| ORM | SQLAlchemy | SQLite/MySQL 双支持 |
| 图片处理 | Pillow | EXIF 解析、缩略图、裁剪/色调 |
| 认证 | JWT | 前后端分离鉴权 |
| AI | Qwen3-VL | AI 标签生成与 MCP 检索 |

### 3.11 工程规范（建议强制）

- 后端：black + isort + flake8（或 ruff）+ mypy（可选）。
- 前端：eslint + prettier。
- Git：提交前 pre-commit。
- OpenAPI：作为唯一接口契约，前端可用 openapi-typescript 生成 types。

### 3.12 配置设计（config.yaml）

- 约束：`config.yaml` 位于项目根目录；允许管理界面更新与热重载，但配置**不得入库**。
- 关键结构：port、site、links、storage、upload、pagination、thumbnail、database、security、qwen。
- 热重载策略：
  - 启动加载一次并缓存。
  - 每次请求检查 mtime，变化即重新加载。
  - 写配置使用文件锁，临时文件原子替换。

### 3.13 文件存储设计

- 原图路径：`{root_dir}/{year}/{month}/{day}/{hash}.{ext}`，hash 为 8 位随机字符。
- 备份路径：`{backup_dir}/{year}/{month}/{day}/{hash}_{timestamp}.{ext}`。
- 校验与安全：
  - 后缀白名单与文件大小限制。
  - Pillow 打开验证、建议校验 MIME/魔数。
  - 防路径穿越：路径由系统拼装，不信任用户输入。

### 3.14 关键业务流程设计

**注册与审批**
1. 提交注册信息并校验。
2. 创建 role=pending。
3. pending 登录后访问图片接口返回 403。
4. 管理员审批后 role=user。

**上传图片**
1. multipart 上传，鉴权 user/admin。
2. 校验后缀白名单、大小、Pillow 打开。
3. 写入 images 主表并记录原始文件名。
4. 生成 hash 并按日期落盘。
5. 写入分辨率、拍摄时间、地点、EXIF KV。
6. 基于 EXIF 生成标签（source=exif）。
7. 生成缩略图（等比缩放）并 base64 入库。
8. 返回图片 ID 与 public_url。

**浏览/检索**
- `GET /api/images` 按 created_at 倒序分页。
- 支持 tags、tag_mode、include_deleted（admin）。
- 返回缩略图与基础信息。

**编辑（裁剪/色调）**
- 预览接口 `POST /api/images/{id}/edit/preview`。
- 编辑前备份原图，Pillow 处理并覆盖原图。
- 删除缩略图记录，更新 updated_at，可选择立即重建。

**删除与恢复**
- 软删除：`is_deleted=true`，保留磁盘文件。
- 恢复：`is_deleted=false`。

### 3.15 OpenAPI 接口约定

- Base URL：`/api`
- 鉴权：`Authorization: Bearer <JWT>`
- 时间：ISO8601
- 错误格式：

```json
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "email format invalid",
    "details": { "field": "email" }
  }
}
```

- 常见错误码：400/401/403/404/409/413/415/500。

### 3.16 后端模块设计与职责

**目录结构**

```
backend/
  app.py
  openapi.yaml
  src/
    api/
    core/
    models/
    services/
    repositories/
    utils/
  migrations/
```

**核心服务**
- AuthService：注册、登录、JWT 签发与密码哈希。
- UserService：审批、角色变更、改密。
- ImageService：上传校验、落盘、元数据解析、标签管理、列表检索、软删除/恢复。
- ThumbnailService：生成/更新/失效缩略图。
- EditService：编辑备份、裁剪/色调处理、更新缩略图。
- ConfigService：配置加载与写入（原子替换、锁）。

### 3.17 前端界面与交互设计

- 路由：`/register`、`/login`、`/upload`、`/browse`、`/images/:id`、`/settings`。
- 全局状态：auth token + role；axios 拦截器自动注入 JWT；Route Guard 限制 pending。
- 注册：用户名/邮箱/密码校验，提示等待审批。
- 登录：pending 跳转提示页或 settings；user/admin 进入 browse。
- 上传：拖拽/选择文件，多文件并行上传，单文件进度条，成功后复制 public_url。
- 浏览：瀑布流缩略图 + placeholder，滚动加载；标签筛选、tag_mode 切换；卡片可复制外链。
- 详情：大图与元数据、标签、EXIF；编辑区 Accordion 互斥展开；预览区展示裁剪/色调实时效果；删除/恢复按钮。
- 设置：改密码；admin 管理站点名与 favicon。
- Layout 组件：AppBar sticky + 滚动阴影变化；Container 统一间距；CardContent padding 统一为 16，避免额外空隙。

### 3.18 安全设计

- 密码哈希存储（bcrypt/argon2）。
- JWT 包含 user_id、role，过期时间可配置。
- OpenAPI 声明 BearerAuth，middleware 校验并注入用户信息。
- 权限装饰器：`require_role`、`require_owner_or_admin`。
- 上传安全：白名单后缀 + Pillow 校验 + 大小限制 + 随机文件名；避免 SVG 等高风险格式。

### 3.19 性能与可维护性

- 列表接口仅返回必要字段，缩略图体积可控。
- 索引建议：images(created_at, is_deleted)、image_tags(image_id, tag_id)、tags(name)。
- 编辑后缩略图失效并重建。
- 建议记录上传/编辑/删除日志（可结构化日志或审计表）。

### 3.20 测试设计

- 后端（pytest）：
  - 注册校验（密码长度、邮箱格式、重复用户名/邮箱）
  - 登录成功/失败
  - pending 访问图片接口 403
  - 上传非法后缀/伪造文件 415/400
  - EXIF/GPS 解析正确
  - 裁剪/色调边界值与备份文件存在
  - 软删除/恢复流程
- 前端（建议）：
  - e2e：注册 → 审批 → 上传 → 浏览 → 编辑 → 删除 → 恢复
  - 组件测试：上传进度、瀑布流加载、标签过滤

### 3.21 部署与运维建议

- Docker Compose：backend + frontend（或 nginx）+ mysql（可选）。
- volumes：`./data`、图片目录、`./config.yaml`、`./openapi.yaml`。
- 现有实现：`docker-compose.yml` 使用 `python:3.10` + `node:22` + `pnpm`，前端通过 `VITE_BACKEND_ORIGIN=http://backend:6007` 代理后端，端口 6007/5173。
- 数据迁移：Alembic 统一管理；提供 `migration/migrate_images.py` 扫描目录导入历史图片并补全元数据与缩略图。

### 3.22 扩展接口预留设计

- AI 标签：
  - tags.source=ai，保留自定义/EXIF 标签。
  - 配置项：`qwen.enabled/api_key/base_url/model/max_retries/timeout/max_tags`。
  - `POST /api/images/{id}/ai-analyze`：仅上传者调用，图片 base64 请求 Qwen3-VL（兼容模式），结果入库。
  - `GET /api/images/{id}/ai-status`：返回状态与标签。
  - 前端：详情页“AI 生成标签”按钮。
- MCP：
  - 预留 `/api/mcp/search`，将自然语言转为结构化检索。

### 3.23 研发任务拆分清单

- 后端：B1 骨架与基础设施；B2 用户与鉴权；B3 审批与角色；B4 上传落盘；B5 EXIF/元数据；B6 缩略图；B7 列表与分页；B8 详情与原图流；B9 编辑与备份；B10 软删除与恢复；B11 站点配置更新。
- 前端：F1 基础设施与路由守卫；F2 注册；F3 登录；F4 上传；F5 瀑布流浏览与过滤；F6 详情与编辑；F7 设置页。
- QA/DevOps：Q1 API 合约测试；Q2 E2E 流程测试；D1 Docker 化与一键启动。

### 3.24 关键实现细节决策

1. 标签过滤默认 `tag_mode=any`，同时支持 `all`。
2. 缩略图 base64 统一存“不带 data:image 前缀”。
3. pending 权限：除 `/auth/*`、`/users/me`、`/users/me/password` 外一律 403。
4. 编辑后缩略图策略：可立即重建或下次请求重建（推荐立即重建）。
5. 图片操作权限：user 仅操作自己上传图片，admin 可操作全部。

### 3.25 图片详情页分栏样式与操作区规范

- 大屏（md 及以上）左右 9:3 分栏；小屏右栏在上、左栏在下。
- 左栏：大图 → 基础信息 → 编辑区域。
- 右栏：复制外链、删除/恢复、自定义标签 textarea、更新按钮；各自占满一行。
- 标签输入默认展示已有标签（逗号分隔）。
- 实现建议：`flexDirection: { xs: 'column', md: 'row' }`，`flex: 3/1`，按钮使用 `fullWidth`。

### 3.26 系统运行环境

#### 3.26.1 软件环境
- Python 3.10（后端）
- Node.js 22 + pnpm（前端）
- SQLite 3（默认）/ MySQL 8（可选）
- Docker + docker-compose（可选部署方式）
- 操作系统：Linux/Windows/macOS 均可

#### 3.26.2 硬件环境
- CPU：双核及以上
- 内存：≥ 4GB（推荐 8GB）
- 磁盘：≥ 20GB（视图片规模扩展）

---

## 四、数据库设计与 ER 图

### 4.1 数据表设计

#### 4.1.1 users 表
| 字段 | 类型 | 约束 | 说明 |
| --- | --- | --- | --- |
| id | int | PK | 用户 ID |
| username | varchar(64) | unique | 用户名 |
| email | varchar(255) | unique | 邮箱 |
| password_hash | varchar(255) | not null | 密码哈希 |
| role | varchar(16) | not null | pending/user/admin |
| created_at | datetime | not null | 创建时间 |
| last_login_at | datetime | nullable | 最近登录 |
| is_active | bool | default true | 是否可用 |

#### 4.1.2 images 表
| 字段 | 类型 | 约束 | 说明 |
| --- | --- | --- | --- |
| id | int | PK | 图片 ID |
| uploader_id | int | FK | 上传者 |
| original_filename | varchar(255) | nullable | 原始文件名 |
| ext | varchar(16) | not null | 后缀 |
| hash | varchar(16) | index | 随机 hash |
| storage_relpath | varchar(512) | not null | 相对路径 |
| size_bytes | bigint | not null | 文件大小 |
| mime_type | varchar(64) | nullable | MIME |
| sha256 | varchar(64) | nullable | 校验值 |
| created_at | datetime | index | 上传时间 |
| updated_at | datetime | not null | 更新时间 |
| is_deleted | bool | index | 软删除 |
| is_favorite | bool | index | 收藏标记 |
| deleted_at | datetime | nullable | 删除时间 |

#### 4.1.3 image_dimensions 表
| 字段 | 类型 | 约束 | 说明 |
| --- | --- | --- | --- |
| image_id | int | PK/FK | 关联图片 |
| width | int | not null | 宽度 |
| height | int | not null | 高度 |

#### 4.1.4 image_capture_time 表
| 字段 | 类型 | 约束 | 说明 |
| --- | --- | --- | --- |
| image_id | int | PK/FK | 关联图片 |
| taken_at | datetime | index | 解析时间 |
| taken_at_raw | varchar(64) | nullable | 原始 EXIF |

#### 4.1.5 image_location 表
| 字段 | 类型 | 约束 | 说明 |
| --- | --- | --- | --- |
| image_id | int | PK/FK | 关联图片 |
| latitude | numeric(10,7) | index | 纬度 |
| longitude | numeric(10,7) | index | 经度 |
| altitude | numeric(10,2) | nullable | 海拔 |
| gps_raw | text | nullable | 原始 GPS |

#### 4.1.6 image_exif_entries 表
| 字段 | 类型 | 约束 | 说明 |
| --- | --- | --- | --- |
| id | int | PK | 主键 |
| image_id | int | FK | 关联图片 |
| exif_key | varchar(128) | index | EXIF Key |
| exif_value | text | nullable | EXIF Value |

#### 4.1.7 tags / image_tags 表
| 字段 | 类型 | 约束 | 说明 |
| --- | --- | --- | --- |
| tags.id | int | PK | 标签 ID |
| tags.name | varchar(64) | not null | 标签名 |
| tags.source | varchar(16) | not null | custom/exif/ai |
| image_tags.image_id | int | PK/FK | 图片关联 |
| image_tags.tag_id | int | PK/FK | 标签关联 |

#### 4.1.8 image_thumbnail 表
| 字段 | 类型 | 约束 | 说明 |
| --- | --- | --- | --- |
| image_id | int | PK/FK | 关联图片 |
| format | varchar(16) | not null | jpeg/png |
| width | int | not null | 宽度 |
| height | int | not null | 高度 |
| size_bytes | bigint | nullable | 缩略图大小 |
| data_base64 | text | not null | base64 |
| created_at | datetime | not null | 生成时间 |

### 4.2 ER 图

```text
users 1 ── N images
images 1 ── 1 image_dimensions
images 1 ── 1 image_capture_time
images 1 ── 1 image_location
images 1 ── N image_exif_entries
images N ── N tags (via image_tags)
images 1 ── 1 image_thumbnail
```

---

## 五、系统接口设计

### 5.1 用户与认证接口

| 接口 | 方法 | 说明 |
| --- | --- | --- |
| /api/auth/register | POST | 用户注册（role= pending） |
| /api/auth/login | POST | 用户登录并获取 JWT |
| /api/users/me | GET | 获取当前用户信息 |
| /api/users/me/password | PATCH | 修改密码 |

### 5.2 管理员接口

| 接口 | 方法 | 说明 |
| --- | --- | --- |
| /api/admin/users | GET | 用户列表（可筛选 pending） |
| /api/admin/users/{user_id}/approve | POST | 审批用户 |
| /api/admin/users/{user_id}/role | POST | 设置用户角色 |
| /api/admin/config | GET/PUT | 获取/更新站点配置 |

### 5.3 图片与标签接口

| 接口 | 方法 | 说明 |
| --- | --- | --- |
| /api/images | GET | 图片列表（分页/标签/删除过滤） |
| /api/images | POST | 上传图片（multipart） |
| /api/images/{image_id} | GET | 图片详情 |
| /api/images/{image_id} | DELETE | 软删除图片 |
| /api/images/{image_id}/restore | POST | 恢复图片 |
| /api/images/{image_id}/file | GET | 获取原图（需鉴权） |
| /images/{year}/{month}/{day}/{filename} | GET | 公开直链访问 |
| /api/images/{image_id}/thumbnail | GET | 获取缩略图 |
| /api/images/{image_id}/tags | PUT | 更新图片标签 |
| /api/tags | GET | 标签列表 |

**列表检索参数**
- page/page_size：分页控制
- tags：逗号分隔标签
- tag_mode：any/all
- include_deleted：管理员可查看已删除

### 5.4 编辑、收藏与 AI 接口

| 接口 | 方法 | 说明 |
| --- | --- | --- |
| /api/images/{image_id}/edit/preview | POST | 编辑预览（裁剪/色调） |
| /api/images/{image_id}/edit/crop | POST | 裁剪图片 |
| /api/images/{image_id}/edit/hue | POST | 调整色调 |
| /api/images/favorites | GET | 收藏列表 |
| /api/images/{image_id}/favorite | POST/DELETE | 收藏/取消收藏 |
| /api/images/{image_id}/ai-analyze | POST | AI 生成标签 |
| /api/images/{image_id}/ai-status | GET | AI 生成状态 |

### 5.5 MCP 检索接口

| 接口 | 方法 | 说明 |
| --- | --- | --- |
| /api/mcp/search | POST | MCP 智能检索 |

---

## 六、系统界面原型

### 6.1 登录界面
- 用户名/密码输入，登录后获取 JWT 并进入系统。
- 提供跳转注册入口与错误提示。

### 6.2 注册界面
- 用户名、邮箱、密码校验。
- 注册后提示等待管理员审批。

### 6.3 浏览首页（瀑布流 + 收藏轮播）
- 默认瀑布流展示缩略图，滚动加载。
- 支持标签筛选与 tag_mode 切换。
- 收藏轮播置顶展示，突出重点图片。
- 可切换为列表视图，显示更多结构化信息。

### 6.4 上传界面
- 拖拽/选择文件上传，多文件并行。
- 支持 Ctrl+V 粘贴图片上传。
- 上传进度条与一键复制直链。

### 6.5 图片详情与编辑界面
- 展示原图、标签、EXIF、地点、尺寸等元数据。
- 收藏/取消收藏按钮。
- 编辑预览 + 裁剪/色调调整，提交后刷新缩略图。
- AI 生成标签按钮与错误提示。

### 6.6 AI 找图界面
- 输入自然语言描述。
- 展示 AI 解析的关键词与匹配图片横向列表。

### 6.7 设置界面
- 用户设置：修改密码。
- 管理员设置：站点名称、favicon、允许后缀、分页大小、外链基址。

---

## 七、附录

### 7.1 项目进度安排（示例）
| 阶段 | 周期 | 产出 |
| --- | --- | --- |
| 需求分析与原型 | 第 1 周 | 需求清单、页面原型 |
| 架构设计 | 第 2 周 | OpenAPI、数据库设计 |
| 后端开发 | 第 3-4 周 | 核心 API 与存储模块 |
| 前端开发 | 第 5-6 周 | 上传/浏览/详情/设置 |
| AI 与优化 | 第 7 周 | AI 标签、MCP 检索 |
| 测试与验收 | 第 8 周 | 功能测试与文档完善 |

### 7.2 备注
- 默认管理员账号：`admin / 123456`。
- 配置文件位于项目根目录 `config.yaml`，支持热加载。
- 后端遵循 “Let it crash” 原则，优先暴露异常以便快速定位问题。
